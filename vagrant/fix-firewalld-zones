#!/usr/bin/env ruby

#
# Ubiquitous Moodle
#
# @author Luke Carrier <luke.carrier@floream.com>
# @copyright 2015 Floream Limited
#

enable_cmd  = "sudo systemctl start firewalld && sudo systemctl enable firewalld"
add_svc_cmd = "sudo firewall-cmd --permanent --zone=public --add-service="
reload_cmd  = "sudo firewall-cmd --reload"

rules = {
  "salt"        => ["salt-master"],
  "app-debug-1" => ["http"],
  "db-1"        => ["postgresql"],
}

rules.each do |vm, services|
  cmd =  "#{enable_cmd}"
  services.each {|service| cmd << " && #{add_svc_cmd}#{service}"}
  cmd << " && #{reload_cmd}"

  system("vagrant", "ssh", vm, "--command", cmd)
end
